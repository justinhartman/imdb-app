</body>
<script>
  (function() {
    const btn = document.getElementById('server-toggle');
    const player = document.getElementById('player');
    if (!btn || !player) return;
    const preferenceKey = btn.dataset.preferenceKey || 'preferredServer';
    const storageKey = `binger:${preferenceKey}`;

    const persistPreference = (value) => {
      if (value !== '1' && value !== '2') return;
      if (typeof window !== 'undefined' && window.localStorage) {
        try {
          window.localStorage.setItem(storageKey, value);
        } catch (error) {
          // ignore storage failures
        }
      }
      document.cookie = `${preferenceKey}=${value};path=/;max-age=${60 * 60 * 24 * 365}`;
    };

    const readCookiePreference = () => {
      const parts = document.cookie.split(';').map((part) => part.trim());
      for (const part of parts) {
        if (!part.startsWith(`${preferenceKey}=`)) continue;
        const value = part.split('=')[1];
        if (value === '1' || value === '2') {
          return value;
        }
      }
      return '';
    };

    const readStoredPreference = () => {
      let value = '';
      if (typeof window !== 'undefined' && window.localStorage) {
        try {
          value = window.localStorage.getItem(storageKey) || '';
        } catch (error) {
          value = '';
        }
      }
      if (value !== '1' && value !== '2') {
        value = readCookiePreference();
        if (value && typeof window !== 'undefined' && window.localStorage) {
          try {
            window.localStorage.setItem(storageKey, value);
          } catch (error) {
            // ignore storage failures
          }
        }
      }
      return value === '1' || value === '2' ? value : '';
    };

    const applyServer = (target) => {
      const server1 = btn.dataset.server1 || '';
      const server2 = btn.dataset.server2 || '';
      const hasServer2 = Boolean(server2.trim());
      const next = target === '2' && hasServer2 ? '2' : '1';

      if (next === '2') {
        player.src = server2;
        btn.dataset.current = '2';
        btn.innerHTML = '<i class="bi bi-hdd-stack"></i> Server 1';
        persistPreference('2');
        return '2';
      }

      player.src = server1;
      btn.dataset.current = '1';
      btn.innerHTML = '<i class="bi bi-hdd-stack"></i> Server 2';
      persistPreference('1');
      return '1';
    };

    const savedPreference = readStoredPreference();
    if (savedPreference) {
      if (savedPreference !== btn.dataset.current) {
        applyServer(savedPreference);
      } else {
        persistPreference(savedPreference);
      }
    } else if (btn.dataset.current) {
      persistPreference(btn.dataset.current);
    }

    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const next = this.dataset.current === '1' ? '2' : '1';
      applyServer(next);
    });
  })();
</script>
</html>
